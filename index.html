
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JumperAI Game Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light-blue': '#E6F3FF',
                        'light-grey': '#F0F0F0',
                    },
                },
            },
        }
    </script>
</head>
<body class="min-h-screen flex flex-col bg-white text-gray-800">
    <header class="bg-light-blue p-4 shadow-md">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">JumperAI Game Hub</h1>
            <div>
                <a href="https://jumperai.org" class="bg-white text-gray-800 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors mr-2">
                    Return to JumperAI
                </a>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600 transition-colors">
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4">
        <div class="w-full overflow-hidden rounded-lg shadow-lg">
            <iframe id="hub-world-frame" src="https://jumperai-hub.netlify.app" width="1024" height="820" frameborder="0" allowfullscreen class="w-full"></iframe>
        </div>
    </main>

    <footer class="bg-light-blue p-4 mt-8">
        <div class="container mx-auto text-center text-gray-600">
            <p>&copy; 2024 JumperAI. All rights reserved.</p>
        </div>
    </footer>

    
	<script>
		const SERVER_URL = 'https://game-progress-server.onrender.com';
		const LOGIN_URL = 'https://jumperai.org/log-in';

		function getToken() {
			return localStorage.getItem('token');
		}

		function setToken(token) {
			localStorage.setItem('token', token);
		}

		function removeToken() {
			localStorage.removeItem('token');
		}

		async function validateToken() {
			const token = getToken();
			if (!token) {
				console.log('No token found in localStorage');
				return false;
			}

			try {
				console.log('Validating token...');
				const response = await fetch(`${SERVER_URL}/validate-token`, {
					method: 'GET',
					headers: {
						'Authorization': `Bearer ${token}`
					}
				});
				const data = await response.json();
				console.log('Token validation response:', data);
				return data.valid;
			} catch (error) {
				console.error('Error validating token:', error);
				return false;
			}
		}

		async function logout() {
			console.log('Logging out...');
			removeToken();
			window.location.href = LOGIN_URL;
		}

		async function checkLoginStatus() {
			console.log('Checking login status...');
			const isValid = await validateToken();
			if (!isValid) {
				console.log('Token is invalid or not present, redirecting to login...');
				window.location.href = LOGIN_URL;
			}
			return isValid;
		}

		async function initializeGame() {
			console.log('Initializing game...');
			const isLoggedIn = await checkLoginStatus();

			if (isLoggedIn) {
				console.log('User is logged in, setting up game frame...');
				const token = getToken();
				const gameFrame = document.getElementById('hub-world-frame');
				if (gameFrame && gameFrame.contentWindow) {
					console.log('Posting token to game frame...');
					gameFrame.contentWindow.postMessage({ type: 'SET_TOKEN', token: token }, 'https://jumperai-hub.netlify.app');
				} else {
					console.error('Game frame not found or not ready');
				}
			} else {
				console.log('User is not logged in');
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			console.log('DOM content loaded, initializing...');
			initializeGame();

			const logoutButton = document.getElementById('logout-button');
			if (logoutButton) {
				logoutButton.addEventListener('click', logout);
			} else {
				console.error('Logout button not found');
			}
		});

		window.addEventListener('message', (event) => {
			if (event.origin !== 'https://jumperai-hub.netlify.app') return;
			
			console.log('Received message from game frame:', event.data);
			if (event.data.type === 'GET_TOKEN') {
				const token = getToken();
				console.log('Sending token to game frame');
				event.source.postMessage({ type: 'TOKEN', token: token }, event.origin);
			}
		});

		// Expose for debugging
		window.debugGame = {
			getToken,
			setToken,
			removeToken,
			validateToken,
			checkLoginStatus,
			initializeGame
		};
	</script>

</body>
</html>
