<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JumperAI Game Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light-blue': '#E6F3FF',
                        'light-grey': '#F0F0F0',},
                },
            },
        }
    </script>
</head>
<body class="min-h-screen flex flex-col bg-white text-gray-800">
    <header class="bg-light-blue p-4 shadow-md">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">JumperAI Game Hub</h1>
            <div>
                <a href="https://jumperai.org" class="bg-white text-gray-800 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors mr-2">
                    Return to JumperAI
                </a>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600 transition-colors">
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4">
        <div class="w-full overflow-hidden rounded-lg shadow-lg">
            <iframe id="hub-world-frame" src="https://jumperai-hub.netlify.app" width="1024" height="820" frameborder="0" allowfullscreen class="w-full"></iframe>
        </div>
    </main>

    <footer class="bg-light-blue p-4 mt-8">
        <div class="container mx-auto text-center text-gray-600">
            <p>&copy; 2024 JumperAI. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const SERVER_URL = 'https://game-progress-server.onrender.com';
        const LOGIN_URL = 'https://jumperai.org/log-in';
        const GAME_ORIGIN = 'https://jumperai-hub.netlify.app';
        const HUB_ORIGIN = 'https://hubworldsite.onrender.com';

        function getToken() {
            return localStorage.getItem('token');
        }

        function setToken(token) {
            localStorage.setItem('token', token);
        }

        function removeToken() {
            localStorage.removeItem('token');
        }

        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        async function validateToken(token) {
            try {
                console.log('Validating token...');
                const response = await fetch(`${SERVER_URL}/validate-token`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                console.log('Token validation response:', data);
                return data.valid;
            } catch (error) {
                console.error('Error validating token:', error);
                return false;
            }
        }

        async function refreshToken() {
            try {
                const currentToken = getToken();
                if (!currentToken) {
                    throw new Error('No token to refresh');
                }
                const response = await fetch(`${SERVER_URL}/refresh-token`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                if (data.token) {
                    setToken(data.token);
                    return data.token;
                }
                throw new Error('No token in refresh response');
            } catch (error) {
                console.error('Error refreshing token:', error);
                return null;
            }
        }

        async function logout() {
            console.log('Logging out...');
            removeToken();
            window.location.href = LOGIN_URL;
        }

        function sendTokenToGame(token) {
            const gameFrame = document.getElementById('hub-world-frame');
            if (gameFrame && gameFrame.contentWindow) {
                console.log('Sending token to game frame');
                gameFrame.contentWindow.postMessage({ type: 'SET_TOKEN', token: token }, GAME_ORIGIN);
            } else {
                console.error('Game frame not found or not ready');
            }
        }

        async function initializeGame() {
            console.log('Initializing game...');
            const urlToken = getTokenFromURL();
            let token;
            if (urlToken) {
                console.log('Token found in URL, validating...');
                const isValid = await validateToken(urlToken);
                if (isValid) {
                    console.log('Token is valid, storing in localStorage');
                    setToken(urlToken);
                    token = urlToken;
                // Remove token from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    console.log('Token is invalid, redirecting to login');
                    window.location.href = LOGIN_URL;
                    return;
                }
            } else {
                token = getToken();
                if (!token) {
                    console.log('No token found, redirecting to login');
                    window.location.href = LOGIN_URL;
                    return;
                }
                console.log('Using stored token');
            }

            // Send token immediately
            sendTokenToGame(token);

            // Set up token refresh
            setInterval(async () => {
                const newToken = await refreshToken();
                if (newToken) {
                    sendTokenToGame(newToken);
                } else {
                    console.error('Token refresh failed');
                    // Optionally redirect to login if refresh consistently fails
                }
            }, 30 * 60 * 1000); // Refresh every 30 minutes
        }document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM content loaded, initializing...');
            initializeGame();

            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            } else {
                console.error('Logout button not found');
            }
        });

        window.addEventListener('message', (event) => {
            if (event.origin !== GAME_ORIGIN) {
                console.log('Received message from unexpected origin:', event.origin);
                return;
            }
            
            console.log('Received message from game frame:', event.data);
            if (event.data.type === 'GET_TOKEN') {
                const token = getToken();
                console.log('Game requested token, sending');
                sendTokenToGame(token);
            } else if (event.data.type === 'REFRESH_TOKEN') {
                refreshToken().then(newToken => {
                    if (newToken) {
                        sendTokenToGame(newToken);
                    } else {
                        console.error('Token refresh failed');
                    }
                });
            }
        });

        // Expose for debugging
        window.debugGame = {
            getToken,
            setToken,
            removeToken,
            validateToken,
            refreshToken,
            initializeGame,
            sendTokenToGame
        };
    </script>
</body>
</html>