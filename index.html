
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JumperAI Game Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'light-blue': '#E6F3FF',
                        'light-grey': '#F0F0F0',
                    },
                },
            },
        }
    </script>
</head>
<body class="min-h-screen flex flex-col bg-white text-gray-800">
    <header class="bg-light-blue p-4 shadow-md">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">JumperAI Game Hub</h1>
            <a href="https://jumperai.org" class="bg-white text-gray-800 px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors">
                Return to JumperAI
            </a>
        </nav>
    </header>

    <main class="flex-grow container mx-auto p-4">
        <div class="w-full overflow-hidden rounded-lg shadow-lg">
            <iframe id="hub-world-frame" src="https://jumperai-hub.netlify.app" width="1024" height="820" frameborder="0" allowfullscreen class="w-full"></iframe>
        </div>
    </main>

    <footer class="bg-light-blue p-4 mt-8">
        <div class="container mx-auto text-center text-gray-600">
            <p>&copy; 2024 JumperAI. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const SERVER_URL = 'https://game-progress-server.onrender.com';

        async function fetchAndStoreToken() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                console.error('No userId found in localStorage');
                return null;
            }

            try {
                const response = await fetch(`${SERVER_URL}/get-token/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch token');
                }
                const data = await response.json();
                localStorage.setItem('token', data.token);
                console.log('Token fetched and stored successfully');
                return data.token;
            } catch (error) {
                console.error('Error fetching token:', error);
                return null;
            }
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        function parseToken(token) {
            if (!token) return null;
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(window.atob(base64));
            } catch (error) {
                console.error('Error parsing token:', error);
                return null;
            }
        }

        async function validateToken(token) {
            try {
                const response = await fetch(`${SERVER_URL}/validate-token/${token}`);
                const data = await response.json();
                if (data.valid) {
                    console.log('Token is valid. User ID:', data.userId);
                    return true;
                } else {
                    console.log('Token is invalid');
                    return false;
                }
            } catch (error) {
                console.error('Error validating token:', error);
                return false;
            }
        }

        async function checkLoginStatus() {
            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('token');

            if (!userId || !token) {
                console.log('No userId or token found, user is not logged in');
                return false;
            }

            const isValid = await validateToken(token);
            if (!isValid) {
                console.log('Token is invalid, user needs to log in again');
                return false;
            }

            console.log('User is logged in and token is valid');
            return true;
        }

        async function initializeGame() {
            const isLoggedIn = await checkLoginStatus();

            if (!isLoggedIn) {
                let token = await fetchAndStoreToken();
                if (!token) {
                    console.log('Unable to fetch token, redirecting to login...');
                    window.location.href = 'https://jumperai.org/log-in';
                    return;
                }
            }

            console.log('Initializing game...');
            const token = getToken();
            // Here you can add any game initialization logic
            // For example, you might want to pass the token to your game iframe:
            const gameFrame = document.getElementById('hub-world-frame');
            gameFrame.contentWindow.postMessage({ type: 'SET_TOKEN', token: token }, '*');
        }

        // Make these functions available globally
        window.getToken = getToken;
        window.parseToken = parseToken;

        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', initializeGame);

        // Listen for messages from the iframe
        window.addEventListener('message', (event) => {
            if (event.origin !== 'https://jumperai-hub.netlify.app') return;
            
            if (event.data.type === 'GET_TOKEN') {
                const token = getToken();
                event.source.postMessage({ type: 'TOKEN', token: token }, event.origin);
            }
        });
    </script>
</body>
</html>
